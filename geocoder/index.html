<!DOCTYPE html>
<html>
  <head>
    <title>Geocoder</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>
  <body>

    <form>
      <input id="geocomplete" type="text" placeholder="Type in an address" size="90">
    </form>

    <div class="map-canvas"></div>

    Lat: <input name="lat"><br>
    Lng: <input name="lng"><br><br>

    Number: <input name="number"><br>
    Street: <input name="street"><br>
    Suburb: <input name="suburb"><br>
    City: <input name="city"><br>
    Postcode: <input name="postcode"><br>
    Country: <input name="country"><br>

    <script src="https://maps.googleapis.com/maps/api/js?libraries=places&key=AIzaSyA-aYIWcm8umGxX-3Nmvfx91ugLXOOZGF8"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

    <script src="jquery.geocomplete.min.js"></script>

    <script>
      $(function(){

        function getUrlParam(name, url) {
          if (!url) url = window.location.href;
          name = name.replace(/[\[\]]/g, "\\$&");
          var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
              results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        var initialAddress = getUrlParam("address");
        initialAddress = initialAddress ? initialAddress : '';

        var initialNotes = getUrlParam("notes");
        initialNotes = initialNotes ? initialNotes : '';

        var addressChanged = function (event, place) {
          if (!place) return;
          if (!place.geometry) return;

          var addressTypeToValue = {};
          for(var i = place.address_components.length - 1; i >= 0; i--) {
            var addressComponent = place.address_components[i];
            for(var j = 0; j < addressComponent.types.length; j++) {
              var addressComponentType = addressComponent.types[j];
              addressTypeToValue[addressComponentType] = addressComponent.short_name;
            }
          }

          var data = {
            name: $("#geocomplete").val(),

            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng(),

            number: addressTypeToValue['street_number'] ? addressTypeToValue['street_number'] : '',
            street: addressTypeToValue['route'] ? addressTypeToValue['route'] : '',
            addressTypeToValue['sublocality'] ? addressTypeToValue['sublocality'] : '',
            addressTypeToValue['locality'] ? addressTypeToValue['locality'] : '',
            addressTypeToValue['postal_code'] ? addressTypeToValue['postal_code'] : '',
            addressTypeToValue['country'] ? addressTypeToValue['country'] : ''
          }

          console.log("---")
          console.dir(addressTypeToValue)
          console.dir(place)
          console.dir(data)

          $("[name='lat']").val(data.lat);
          $("[name='lng']").val(data.lng);

          $("[name='number']").val(data.number);
          $("[name='street']").val(data.street);
          $("[name='suburb']").val(data.suburb);
          $("[name='city']").val(data.city);
          $("[name='postcode']").val(data.postcode);
          $("[name='country']").val(data.country);

          window.parent.postMessage(JSON.stringify(data), '*');

        };

        $("#geocomplete").geocomplete({
  				map: ".map-canvas",
          location: initialAddress,
  				componentRestrictions: {country: "nz"},
          types: [],
  				mapOptions: {
  					zoom: 5,
  					center: {lat: -40.917170, lng: 173.456179},
  					draggable: true,
  					gestureHandling: "cooperative",
  					fullscreenControl: false,
  					mapTypeControl: false,
  					streetViewControl: false
  				}
  			})
  				.bind("geocode:result", addressChanged)
  				.bind("geocode:error", function(event, status) {});

      });
    </script>
  </body>
</html>
